const {
    expectEvent, BN
} = require('@openzeppelin/test-helpers')
const { deployProxy } = require('@openzeppelin/truffle-upgrades')

const IUniswapV2Pair = artifacts.require('IUniswapV2Pair')
const IERC20 = artifacts.require('IERC20')

const AccessManager = artifacts.require('UnoAccessManager')
const FarmFactory = artifacts.require('UnoFarmFactory')

const Farm = artifacts.require('UnoFarmSushiswap')
const AssetRouter = artifacts.require('UnoAssetRouterSushiswap')

const AutoStrategy = artifacts.require('UnoAutoStrategy')
const AutoStrategyFactory = artifacts.require('UnoAutoStrategyFactory')

const pool1 = '0x4B1F1e2435A9C96f7330FAea190Ef6A7C8D70001' // usdt usdc sushiswap
const pool2 = '0xc4e595acDD7d12feC385E5dA5D43160e8A0bAC0E' // wmatic-eth sushiswap

const DAIHolder = '0x06959153B974D0D5fDfd87D561db6d8d4FA0bb0B'// has to be unlocked and hold 0xf28164A485B0B2C90639E47b0f377b4a438a16B1

contract('UnoAutoStrategySingleAssetWithdraw', (accounts) => {
    const admin = accounts[0]

    let accessManager; let assetRouter
    let DAIToken
    let autoStrategyFactory
    let autoStrategy
    let strategyToken

    before(async () => {
        const implementation = await Farm.new({ from: admin })
        accessManager = await AccessManager.new({ from: admin })// accounts[0] is admin

        const autoStrategyImplementation = await AutoStrategy.new()
        autoStrategyFactory = await AutoStrategyFactory.new(autoStrategyImplementation.address, accessManager.address)

        assetRouter = await deployProxy(AssetRouter, { kind: 'uups', initializer: false })
        await FarmFactory.new(implementation.address, accessManager.address, assetRouter.address, { from: admin })

        await autoStrategyFactory.approveAssetRouter(assetRouter.address, {
            from: admin
        })

        await autoStrategyFactory.createStrategy([
            { pool: pool1, assetRouter: assetRouter.address },
            { pool: pool2, assetRouter: assetRouter.address }
        ])

        autoStrategy = await AutoStrategy.at(await autoStrategyFactory.autoStrategies(0))
        strategyToken = await IERC20.at(autoStrategy.address)

        DAIToken = await IUniswapV2Pair.at('0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063')
    })

    describe('Single Asset Withdraw', () => {
        describe('withdraw token', () => {
            let id
            let tokenBalanceBefore

            before(async () => {
                id = await autoStrategy.poolID()
                const DAIAmount = new BN('1000000000000000000000') // 1000$
                await DAIToken.approve(autoStrategy.address, DAIAmount, { from: DAIHolder })
                const tokenAData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a0630000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000f04adbf75cdfc5ed26eea4bbbb991db002036bdd000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000eda62fc0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500000000000000000000000000000000000000000000000000000000006700206ae4071138002dc6c0f04adbf75cdfc5ed26eea4bbbb991db002036bdd1111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000eda62fc8f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000000000000000000000000000000000cfee7c08`
                const tokenBData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f000000000000000000000000f04adbf75cdfc5ed26eea4bbbb991db002036bdd000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000ee2d592000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000000000000000000f200a007e5c0d20000000000000000000000000000000000000000000000000000ce00006700206ae4071138002dc6c0f04adbf75cdfc5ed26eea4bbbb991db002036bdd2cf7252e74036d1da831d11089d326296e64a728000000000000000000000000000000000000000000000000000000000ee408aa8f3cf7ad23cd3cadbd9735aff958023239c6a06300206ae40711b8002dc6c02cf7252e74036d1da831d11089d326296e64a7281111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000ee2d5922791bca1f2de4661ed88a30c99a7a9449aa8417400000000000000000000000000000000cfee7c08`
                await autoStrategy.depositSingleAsset(id, DAIToken.address, DAIAmount, [tokenAData, tokenBData], 0, 0, DAIHolder, { from: DAIHolder })

                tokenBalanceBefore = await DAIToken.balanceOf(DAIHolder);
                ({
                    stakeA,
                    stakeB
                } = await autoStrategy.userStake(DAIHolder))
            })
            it('fires events', async () => {
                const tokenAData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa841740000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000f04adbf75cdfc5ed26eea4bbbb991db002036bdd000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}0000000000000000000000000000000000000000000000000000000017d7840000000000000000000000000000000000000000000000000acd5d703e37011b4c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500000000000000000000000000000000000000000000000000000000006700206ae40711b8002dc6c0f04adbf75cdfc5ed26eea4bbbb991db002036bdd1111111254eeb25477b68fb85ed929f73a96058200000000000000000000000000000000000000000000000acd5d703e37011b4c2791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000cfee7c08`
                const tokenBData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}000000000000000000000000000000000000000000000000000000001da7498e00000000000000000000000000000000000000000000000d609936f8c6ae8b350000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042900000000000000000000000000000000000000000000000000000000040b00a0c9e75c48000000000000050202010000000000000000000000000000000000000003dd00034e00023400011a00a007e5c0d20000000000000000000000000000000000000000000000000000f600008f0c20c2132d05d31c914a87c6611c10748aeb04b58e8f604229c960e5cacf2aaeac8be68ac07ba9df81c36ae4071138002dc6c0604229c960e5cacf2aaeac8be68ac07ba9df81c3eef611894ceae652979c9d0dae1deb597790c6ee00000000000000000000000000000000000000000000000134fd0c062221ee7ec2132d05d31c914a87c6611c10748aeb04b58e8f00206ae40711b8002dc6c0eef611894ceae652979c9d0dae1deb597790c6ee1111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000001569d19aee38fc3d00d500b1d8e8ef31e21c99d1db9a6444d3adf127000a007e5c0d20000000000000000000000000000000000000000000000000000f600008f0c20c2132d05d31c914a87c6611c10748aeb04b58e8fe89fae1b4ada2c869f05a0c96c87022dadc7709a6ae4071138002dc6c0e89fae1b4ada2c869f05a0c96c87022dadc7709a74214f5d8aa71b8dc921d8a963a1ba3605050781000000000000000000000000000000000000000000000002b5fbdf4556fda8f7c2132d05d31c914a87c6611c10748aeb04b58e8f00206ae4071138002dc6c074214f5d8aa71b8dc921d8a963a1ba36050507811111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000002acbc7b063770017da3fa99a148fa48d14ed51d610c367c61876997f100a007e5c0d20000000000000000000000000000000000000000000000000000f600008f0c20c2132d05d31c914a87c6611c10748aeb04b58e8ff6422b997c7f54d1c6a6e103bcb1499eea0a70466ae4071138002dc6c0f6422b997c7f54d1c6a6e103bcb1499eea0a70464a35582a710e1f4b2030a3f826da20bfb6703c09000000000000000000000000000000000000000000000000006f681eaa882377c2132d05d31c914a87c6611c10748aeb04b58e8f00206ae40711b8002dc6c04a35582a710e1f4b2030a3f826da20bfb6703c091111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000002ac692a30a9b5b9a67ceb23fd6bc0add59e62ac25578270cff1b9f6190c20c2132d05d31c914a87c6611c10748aeb04b58e8f59153f27eefe07e5ece4f9304ebba1da6f53ca886ae4071138002dc6c059153f27eefe07e5ece4f9304ebba1da6f53ca881111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000006b0d6781301f90c41c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000000000000000000000000000cfee7c08`

                const strategyTokenBalance = await strategyToken.balanceOf(DAIHolder)
                const receipt = await autoStrategy.withdrawSingleAsset(id, strategyTokenBalance, DAIToken.address, [tokenAData, tokenBData], DAIHolder, { from: DAIHolder })
                expectEvent(receipt, 'Withdraw', {
                    poolID: id, from: DAIHolder, recipient: DAIHolder
                })
                expectEvent(receipt, 'WithdrawSingleToken', {
                    poolID: id,
                    token: DAIToken.address
                })
            })
            it('deposits tokens to balance', async () => {
                const tokenBalanceAfter = await DAIToken.balanceOf(DAIHolder)

                const tokenDiff = tokenBalanceAfter.sub(tokenBalanceBefore)
                assert.ok(tokenDiff.gt(new BN(0)), 'Dai Balance not increased')
            })
            it('burns tokens', async () => {
                const strategyTokenBalance = await strategyToken.balanceOf(DAIHolder)

                assert.equal(
                    strategyTokenBalance.toString(),
                    '0',
                    'Amount of tokens burnt is not correct'
                )
            })
            it('updates stakes', async () => {
                const { stakeA, stakeB } = await autoStrategy.userStake(DAIHolder)
                assert.equal(stakeA.toString(), '0', 'Stake not withdrawn')
                assert.equal(stakeB.toString(), '0', 'Stake not withdrawn')
            })
        })
        describe('withdraw ETH', () => {
            let id
            let ethBalanceBefore
            let ethSpentOnGas

            before(async () => {
                id = await autoStrategy.poolID()
                const DAIAmount = new BN('1000000000000000000000') // 1000$
                await DAIToken.approve(autoStrategy.address, DAIAmount, { from: DAIHolder })
                const tokenAData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a0630000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000f04adbf75cdfc5ed26eea4bbbb991db002036bdd000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000eda62fc0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500000000000000000000000000000000000000000000000000000000006700206ae4071138002dc6c0f04adbf75cdfc5ed26eea4bbbb991db002036bdd1111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000eda62fc8f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000000000000000000000000000000000cfee7c08`
                const tokenBData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000008f3cf7ad23cd3cadbd9735aff958023239c6a063000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f000000000000000000000000f04adbf75cdfc5ed26eea4bbbb991db002036bdd000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000ee2d592000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000000000000000000f200a007e5c0d20000000000000000000000000000000000000000000000000000ce00006700206ae4071138002dc6c0f04adbf75cdfc5ed26eea4bbbb991db002036bdd2cf7252e74036d1da831d11089d326296e64a728000000000000000000000000000000000000000000000000000000000ee408aa8f3cf7ad23cd3cadbd9735aff958023239c6a06300206ae40711b8002dc6c02cf7252e74036d1da831d11089d326296e64a7281111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000ee2d5922791bca1f2de4661ed88a30c99a7a9449aa8417400000000000000000000000000000000cfee7c08`
                await autoStrategy.depositSingleAsset(id, DAIToken.address, DAIAmount, [tokenAData, tokenBData], 0, 0, DAIHolder, { from: DAIHolder })

                ethBalanceBefore = new BN(await web3.eth.getBalance(DAIHolder));
                ({
                    stakeA,
                    stakeB
                } = await autoStrategy.userStake(DAIHolder))
            })
            it('fires events', async () => {
                const tokenAData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb0000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa841740000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000006e7a5fafcec6bb1e78bae2a1f0b612012bf14827000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}0000000000000000000000000000000000000000000000000000000017d7840000000000000000000000000000000000000000000000000918693d06f6a1f6310000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500000000000000000000000000000000000000000000000000000000006700206ae4071138002dc6c06e7a5fafcec6bb1e78bae2a1f0b612012bf148271111111254eeb25477b68fb85ed929f73a96058200000000000000000000000000000000000000000000000918693d06f6a1f6312791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000cfee7c08`
                const tokenBData = `0x12aa3caf000000000000000000000000b97cd69145e5a9357b2acd6af6c5076380f17afb000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270000000000000000000000000604229c960e5cacf2aaeac8be68ac07ba9df81c3000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}000000000000000000000000000000000000000000000000000000001ad2748000000000000000000000000000000000000000000000000ae99dde059d767ef40000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500000000000000000000000000000000000000000000000000000000006700206ae4071138002dc6c0604229c960e5cacf2aaeac8be68ac07ba9df81c31111111254eeb25477b68fb85ed929f73a96058200000000000000000000000000000000000000000000000ae99dde059d767ef4c2132d05d31c914a87c6611c10748aeb04b58e8f000000000000000000000000000000000000000000000000000000cfee7c08`

                const strategyTokenBalance = await strategyToken.balanceOf(DAIHolder)
                const receipt = await autoStrategy.withdrawSingleETH(id, strategyTokenBalance, [tokenAData, tokenBData], DAIHolder, { from: DAIHolder })

                const gasUsed = new BN(receipt.receipt.gasUsed)
                const effectiveGasPrice = new BN(receipt.receipt.effectiveGasPrice)

                ethSpentOnGas = gasUsed.mul(effectiveGasPrice)

                expectEvent(receipt, 'Withdraw', {
                    poolID: id, from: DAIHolder, recipient: DAIHolder
                })
                expectEvent(receipt, 'WithdrawSingleETH', {
                    poolID: id
                })
            })
            it('withdraws ETH from balance', async () => {
                const ethBalanceAfter = new BN(await web3.eth.getBalance(DAIHolder))

                const ethDiff = ethBalanceAfter.sub(ethBalanceBefore.add(ethSpentOnGas))
                assert.ok(ethDiff.gt(new BN(0)), 'Eth Balance not increased')
            })
            it('burns tokens', async () => {
                const strategyTokenBalance = await strategyToken.balanceOf(DAIHolder)

                assert.equal(
                    strategyTokenBalance.toString(),
                    '0',
                    'Amount of tokens burnt is not correct'
                )
            })
            it('updates stakes', async () => {
                const { stakeA, stakeB } = await autoStrategy.userStake(DAIHolder)
                assert.equal(stakeA.toString(), '0', 'Stake not withdrawn')
                assert.equal(stakeB.toString(), '0', 'Stake not withdrawn')
            })
        })
    })
})
