const {
    expectRevert, expectEvent, BN, constants
} = require('@openzeppelin/test-helpers')
const { deployProxy } = require('@openzeppelin/truffle-upgrades')

const IUniswapV2Pair = artifacts.require('IUniswapV2Pair')

const AccessManager = artifacts.require('UnoAccessManager')
const FarmFactory = artifacts.require('UnoFarmFactory')

const Farm = artifacts.require('UnoFarmTrisolarisStandard')
const AssetRouter = artifacts.require('UnoAssetRouterTrisolarisStandard')

const pool = '0x2fe064B6c7D274082aa5d2624709bC9AE7D16C77' // usdt usdc

const DAIHolder = '0x456325F2AC7067234dD71E01bebe032B0255e039'// has to be unlocked and hold 0xf28164A485B0B2C90639E47b0f377b4a438a16B1

approxeq = (bn1, bn2, epsilon, message) => {
    const amountDelta = bn1.sub(bn2).add(epsilon)
    assert.ok(!amountDelta.isNeg(), message)
}

contract('UnoAssetRouterTrisolarisStandardSingleAssetWithdrawETH', (accounts) => {
    const admin = accounts[0]

    let accessManager
    let assetRouter
    let DAIToken

    before(async () => {
        const implementation = await Farm.new({ from: admin })
        accessManager = await AccessManager.new({ from: admin })// accounts[0] is admin
        assetRouter = await deployProxy(AssetRouter, { kind: 'uups', initializer: false })
        await FarmFactory.new(implementation.address, accessManager.address, assetRouter.address, { from: admin })
        DAIToken = await IUniswapV2Pair.at('0xe3520349F477A5F6EB06107066048508498A291b')
    })

    describe('Single Asset Withdraw', () => {
        describe('withdraw ETH', () => {
            let stakeLPBefore
            let ethBalanceBefore
            let ethSpentOnGas

            before(async () => {
                const DAIAmount = new BN('1000000000000000000000') // 1000$
                await DAIToken.approve(assetRouter.address, DAIAmount, { from: DAIHolder })
                const tokenAData = `0x12aa3caf0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000e3520349f477a5f6eb06107066048508498a291b0000000000000000000000004988a896b1227218e4a686fde5eabdcabd91571f0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000c9256aa0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060f0000000000000000000000000000000000000005f10005c300006800004e80206c4eca27e3520349f477a5f6eb06107066048508498a291b46a3a41bd932244dd08186e4c19f1a7e48cbcdf40000000000000000000000000000000000000000000000004563918244f400000020d6bdbf78e3520349f477a5f6eb06107066048508498a291b00a0c9e75c480000000000000402020200000000000000000000000000000000000000052d0003c000034500016f00a007e5c0d200000000000000000000000000000000000000000000000000014b00007b0c20e3520349f477a5f6eb06107066048508498a291bbb310ef4fac855f2f49d8fb35a2da8f639b3464e6ae4071118002dc6c0bb310ef4fac855f2f49d8fb35a2da8f639b3464e00000000000000000000000000000000000000000000000000000000028e02cee3520349f477a5f6eb06107066048508498a291b512051d96ef6960cc7b4c884e1215564f926011a4064b12bfca5a55806aaf64e99521918a4bf0fc4080200449169558600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028d79fd00000000000000000000000000000000000000000000000000000000648c99dc00a007e5c0d20000000000000000000000000000000000000000000001b20000e200008f0c20e3520349f477a5f6eb06107066048508498a291b28058325c9d1779b74f5b6ae9ecd83e30bc961b16ae4071138002dc6c028058325c9d1779b74f5b6ae9ecd83e30bc961b120f8aefb5697b77e0bb835a8518be70775cda1b00000000000000000000000000000000000000000001d167f77bdd0d5188702e3e3520349f477a5f6eb06107066048508498a291b00206ae4071118002dc6c020f8aefb5697b77e0bb835a8518be70775cda1b0000000000000000000000000000000000000000000000000000000000283548cc42c30ac6cc15fac9bd938618bcaa1a1fae8501d5120458459e48dbac0c8ca83f8d0b7b29fefe60c3970b12bfca5a55806aaf64e99521918a4bf0fc408020044916955860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002823f5200000000000000000000000000000000000000000000000000000000648c99dc0c20e3520349f477a5f6eb06107066048508498a291b2c4d78a40bab1a6cbb4b59297cd7b2eba21128ef6ae4071118002dc6c02c4d78a40bab1a6cbb4b59297cd7b2eba21128ef0000000000000000000000000000000000000000000000000000000002753017e3520349f477a5f6eb06107066048508498a291b00a007e5c0d20000000000000000000000000000000000000000000001490000f600008f0c20e3520349f477a5f6eb06107066048508498a291b3f239d83af94f836b93910d29704def88542e2a76ae4071138002dc6c03f239d83af94f836b93910d29704def88542e2a763da4db6ef4e7c62168ab03982399f9588fcd19800000000000000000000000000000000000000000000000000ad40c5f46fd703e3520349f477a5f6eb06107066048508498a291b00206ae4071138002dc6c063da4db6ef4e7c62168ab03982399f9588fcd19803b666f3488a7992b2385b12df7f35156d7b29cd0000000000000000000000000000000000000000003a91c19a58e7988b01c7a7c9bdeed33cd01541e1eed10f90519d2c06fe3feb00206ae4071118002dc6c003b666f3488a7992b2385b12df7f35156d7b29cd00000000000000000000000000000000000000000000000000000000050d6d43c42c30ac6cc15fac9bd938618bcaa1a1fae8501d80a06c4eca274988a896b1227218e4a686fde5eabdcabd91571f1111111254eeb25477b68fb85ed929f73a9605820000000000000000000000000000000000b4eb6cb3`
                const tokenBData = `0x12aa3caf0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000e3520349f477a5f6eb06107066048508498a291b000000000000000000000000b12bfca5a55806aaf64e99521918a4bf0fc408020000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000${assetRouter.address.substring(2).toLowerCase()}00000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000c62e920000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006350000000000000000000000000000000000000006170005e900006800004e80206c4eca27e3520349f477a5f6eb06107066048508498a291b46a3a41bd932244dd08186e4c19f1a7e48cbcdf40000000000000000000000000000000000000000000000004563918244f400000020d6bdbf78e3520349f477a5f6eb06107066048508498a291b00a0c9e75c48000000000000050202010000000000000000000000000000000000000005530003e600021000018100a007e5c0d200000000000000000000000000000000000000000000015d0000f600008f0c20e3520349f477a5f6eb06107066048508498a291b2c4d78a40bab1a6cbb4b59297cd7b2eba21128ef6ae4071138002dc6c02c4d78a40bab1a6cbb4b59297cd7b2eba21128ef2639f48ace89298fa2e874ef2e26d4576058ae6d0000000000000000000000000000000000000000000000000000000001560121e3520349f477a5f6eb06107066048508498a291b00206ae40711b8002dc6c02639f48ace89298fa2e874ef2e26d4576058ae6d2f41af687164062f118297ca10751f4b55478ae10000000000000000000000000000000000000000000000000029e7aa4b1875a64988a896b1227218e4a686fde5eabdcabd91571f00206ae4071138002dc6c02f41af687164062f118297ca10751f4b55478ae11111111254eeb25477b68fb85ed929f73a960582000000000000000000000000000000000000000000000000000000000137c6d0c9bdeed33cd01541e1eed10f90519d2c06fe3feb0c20e3520349f477a5f6eb06107066048508498a291bbb310ef4fac855f2f49d8fb35a2da8f639b3464e6ae4071138002dc6c0bb310ef4fac855f2f49d8fb35a2da8f639b3464e1111111254eeb25477b68fb85ed929f73a96058200000000000000000000000000000000000000000000000000000000028e02cee3520349f477a5f6eb06107066048508498a291b00a007e5c0d20000000000000000000000000000000000000000000001b20000e200008f0c20e3520349f477a5f6eb06107066048508498a291b28058325c9d1779b74f5b6ae9ecd83e30bc961b16ae4071138002dc6c028058325c9d1779b74f5b6ae9ecd83e30bc961b103b666f3488a7992b2385b12df7f35156d7b29cd0000000000000000000000000000000000000000001d167f77bdd0d5188702e3e3520349f477a5f6eb06107066048508498a291b00206ae4071118002dc6c003b666f3488a7992b2385b12df7f35156d7b29cd00000000000000000000000000000000000000000000000000000000028316c5c42c30ac6cc15fac9bd938618bcaa1a1fae8501d512051d96ef6960cc7b4c884e1215564f926011a40644988a896b1227218e4a686fde5eabdcabd91571f004491695586000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000283194c00000000000000000000000000000000000000000000000000000000648c99dd00a007e5c0d20000000000000000000000000000000000000000000001490000f600008f0c20e3520349f477a5f6eb06107066048508498a291b3f239d83af94f836b93910d29704def88542e2a76ae4071138002dc6c03f239d83af94f836b93910d29704def88542e2a763da4db6ef4e7c62168ab03982399f9588fcd19800000000000000000000000000000000000000000000000000d161689dbe747ae3520349f477a5f6eb06107066048508498a291b00206ae4071138002dc6c063da4db6ef4e7c62168ab03982399f9588fcd19820f8aefb5697b77e0bb835a8518be70775cda1b000000000000000000000000000000000000000000046c48145a8d875755fc901c9bdeed33cd01541e1eed10f90519d2c06fe3feb00206ae4071118002dc6c020f8aefb5697b77e0bb835a8518be70775cda1b000000000000000000000000000000000000000000000000000000000061a0636c42c30ac6cc15fac9bd938618bcaa1a1fae8501d80a06c4eca27b12bfca5a55806aaf64e99521918a4bf0fc408021111111254eeb25477b68fb85ed929f73a9605820000000000000000000000b4eb6cb3`
                await assetRouter.depositWithSwap(pool, [tokenAData, tokenBData], DAIHolder, { from: DAIHolder })

                ethBalanceBefore = new BN(await web3.eth.getBalance(DAIHolder));
                ({
                    stakeLP: stakeLPBefore
                } = await assetRouter.userStake(DAIHolder, pool))
            })
            it('fires events', async () => {
                const tokenAData = '0x12aa3caf0000000000000000000000007731f8df999a9441ae10519617c24568dc82f6970000000000000000000000004988a896b1227218e4a686fde5eabdcabd91571f000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000456325F2AC7067234dD71E01bebe032B0255e039000000000000000000000000000000000000000000000000000000000ee6b28000000000000000000000000000000000000000000000000000f83baa9aa83818000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b700000000000000000000000000000000000000039900038300006800004e80206c4eca274988a896b1227218e4a686fde5eabdcabd91571f46a3a41bd932244dd08186e4c19f1a7e48cbcdf400000000000000000000000000000000000000000000000000000000002625a00020d6bdbf784988a896b1227218e4a686fde5eabdcabd91571f00a0c9e75c48000000000000000008020000000000000000000000000000000000000000000000000002ed0001ab00a007e5c0d200000000000000000000000000000000000000000000018700014b0000d0512051d96ef6960cc7b4c884e1215564f926011a40644988a896b1227218e4a686fde5eabdcabd91571f004491695586000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000179a93600000000000000000000000000000000000000000000000000000000648c99df0c20b12bfca5a55806aaf64e99521918a4bf0fc408022f41af687164062f118297ca10751f4b55478ae16ae4071198002dc6c02f41af687164062f118297ca10751f4b55478ae10000000000000000000000000000000000000000000000000031b2d0bde3d6f5b12bfca5a55806aaf64e99521918a4bf0fc408024101c9bdeed33cd01541e1eed10f90519d2c06fe3feb00042e1a7d4d000000000000000000000000000000000000000000000000000000000000000000a007e5c0d200000000000000000000000000000000000000000000011e0000e200008f0c204988a896b1227218e4a686fde5eabdcabd91571f03b666f3488a7992b2385b12df7f35156d7b29cd6ae40711b8002dc6c003b666f3488a7992b2385b12df7f35156d7b29cd63da4db6ef4e7c62168ab03982399f9588fcd19800000000000000000000000000000000000000000043aad875e53a7a4a8424eb4988a896b1227218e4a686fde5eabdcabd91571f00206ae4071198002dc6c063da4db6ef4e7c62168ab03982399f9588fcd19800000000000000000000000000000000000000000000000000c688d9dcc46122c42c30ac6cc15fac9bd938618bcaa1a1fae8501d4101c9bdeed33cd01541e1eed10f90519d2c06fe3feb00042e1a7d4d0000000000000000000000000000000000000000000000000000000000000000c0611111111254eeb25477b68fb85ed929f73a960582000000000000000000b4eb6cb3'
                const tokenBData = '0x12aa3caf0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000b12bfca5a55806aaf64e99521918a4bf0fc40802000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007731f8df999a9441ae10519617c24568dc82f697000000000000000000000000456325F2AC7067234dD71E01bebe032B0255e039000000000000000000000000000000000000000000000000000000000ee6b28000000000000000000000000000000000000000000000000000f81205af99a614000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003b700000000000000000000000000000000000000039900038300006800004e80206c4eca27b12bfca5a55806aaf64e99521918a4bf0fc4080246a3a41bd932244dd08186e4c19f1a7e48cbcdf400000000000000000000000000000000000000000000000000000000002625a00020d6bdbf78b12bfca5a55806aaf64e99521918a4bf0fc4080200a0c9e75c48000000000000000008020000000000000000000000000000000000000000000000000002ed0000db00a007e5c0d20000000000000000000000000000000000000000000000000000b700007b0c20b12bfca5a55806aaf64e99521918a4bf0fc408022f41af687164062f118297ca10751f4b55478ae16ae4071198002dc6c02f41af687164062f118297ca10751f4b55478ae10000000000000000000000000000000000000000000000000031b29dd750a42ab12bfca5a55806aaf64e99521918a4bf0fc408024101c9bdeed33cd01541e1eed10f90519d2c06fe3feb00042e1a7d4d000000000000000000000000000000000000000000000000000000000000000000a007e5c0d20000000000000000000000000000000000000001ee0001b200015f0000d0512051d96ef6960cc7b4c884e1215564f926011a4064b12bfca5a55806aaf64e99521918a4bf0fc408020044916955860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e5623600000000000000000000000000000000000000000000000000000000648c99e00c204988a896b1227218e4a686fde5eabdcabd91571f03b666f3488a7992b2385b12df7f35156d7b29cd6ae40711b8002dc6c003b666f3488a7992b2385b12df7f35156d7b29cd63da4db6ef4e7c62168ab03982399f9588fcd198000000000000000000000000000000000000000000439cb40029ad0480d93dcf4988a896b1227218e4a686fde5eabdcabd91571f00206ae4071198002dc6c063da4db6ef4e7c62168ab03982399f9588fcd19800000000000000000000000000000000000000000000000000c65f67d84901eac42c30ac6cc15fac9bd938618bcaa1a1fae8501d4101c9bdeed33cd01541e1eed10f90519d2c06fe3feb00042e1a7d4d0000000000000000000000000000000000000000000000000000000000000000c0611111111254eeb25477b68fb85ed929f73a960582000000000000000000b4eb6cb3'
                const receipt = await assetRouter.withdrawWithSwap(pool, stakeLPBefore, [tokenAData, tokenBData], DAIHolder, { from: DAIHolder })

                const gasUsed = new BN(receipt.receipt.gasUsed)
                const effectiveGasPrice = new BN(receipt.receipt.effectiveGasPrice)

                ethSpentOnGas = gasUsed.mul(effectiveGasPrice)

                expectEvent(receipt, 'Withdraw', {
                    lpPool: pool, sender: DAIHolder, recipient: DAIHolder, amount: stakeLPBefore
                })
            })
            it('withdraws ETH from balance', async () => {
                const ethBalanceAfter = new BN(await web3.eth.getBalance(DAIHolder))

                const ethDiff = ethBalanceAfter.sub(ethBalanceBefore.add(ethSpentOnGas))
                assert.ok(ethDiff.gt(new BN(0)), 'Eth Balance not increased')
            })
            it('updates stakes', async () => {
                const { stakeLP } = await assetRouter.userStake(DAIHolder, pool)
                assert.equal(stakeLP.toString(), '0', 'Stake not withdrawn')
            })
            it('updates totalDeposits', async () => {
                const { totalDepositsLP } = await assetRouter.totalDeposits(pool)
                assert.equal(totalDepositsLP.toString(), '0', 'Stake not withdrawn')
            })
        })
    })
})
